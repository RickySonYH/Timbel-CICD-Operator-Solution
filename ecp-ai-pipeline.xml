<?xml version='1.1' encoding='UTF-8'?>
<!-- [advice from AI] ECP-AI K8s Orchestrator í”„ë¡œì íŠ¸ìš© Jenkins íŒŒì´í”„ë¼ì¸ -->
<flow-definition plugin="workflow-job@1316.vd2290d3341a_f">
  <actions/>
  <description>ECP-AI Kubernetes Orchestrator - Multi-tenant AI Service Deployment System</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
      <triggers>
        <com.cloudbees.jenkins.GitHubPushTrigger plugin="github@1.37.3.1">
          <spec></spec>
        </com.cloudbees.jenkins.GitHubPushTrigger>
      </triggers>
    </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@3659.v582dc37621d8">
    <script>pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'localhost:8082'
        NEXUS_REGISTRY = 'localhost:8081'
        PROJECT_NAME = 'ecp-ai-k8s-orchestrator'
        BUILD_VERSION = "${BUILD_NUMBER}-${GIT_COMMIT.take(7)}"
        KUBECONFIG = '/var/jenkins_home/.kube/config'
    }
    
    stages {
        stage('ğŸ” Checkout') {
            steps {
                echo 'ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ ì¤‘...'
                git branch: 'main', 
                    url: 'https://github.com/RickySonYH/ecp-ai-k8s-orchestrator.git'
                
                script {
                    env.GIT_COMMIT = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()
                    env.BUILD_VERSION = "${BUILD_NUMBER}-${env.GIT_COMMIT.take(7)}"
                }
                
                echo "âœ… ì²´í¬ì•„ì›ƒ ì™„ë£Œ: ${env.GIT_COMMIT}"
            }
        }
        
        stage('ğŸ”§ Build Backend') {
            steps {
                echo 'ğŸ Python ë°±ì—”ë“œ ë¹Œë“œ ì¤‘...'
                dir('backend') {
                    sh '''
                        echo "ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜..."
                        python3 -m pip install --user -r requirements.txt
                        
                        echo "ğŸ§ª Python ì½”ë“œ ê²€ì¦..."
                        python3 -m py_compile *.py || echo "âš ï¸ Python ì»´íŒŒì¼ ê²½ê³  ë¬´ì‹œ"
                        
                        echo "âœ… ë°±ì—”ë“œ ë¹Œë“œ ì™„ë£Œ"
                    '''
                }
            }
        }
        
        stage('ğŸ¨ Build Frontend') {
            steps {
                echo 'âš›ï¸ React í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì¤‘...'
                dir('frontend') {
                    sh '''
                        echo "ğŸ“¦ Node.js ì˜ì¡´ì„± ì„¤ì¹˜..."
                        npm install --silent
                        
                        echo "ğŸ—ï¸ React ì•± ë¹Œë“œ..."
                        npm run build
                        
                        echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì™„ë£Œ"
                    '''
                }
            }
        }
        
        stage('ğŸ³ Build Docker Images') {
            parallel {
                stage('Backend Image') {
                    steps {
                        echo 'ğŸ ë°±ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...'
                        dir('backend') {
                            sh '''
                                docker build -t ${PROJECT_NAME}-backend:${BUILD_VERSION} .
                                docker tag ${PROJECT_NAME}-backend:${BUILD_VERSION} ${PROJECT_NAME}-backend:latest
                                echo "âœ… ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
                            '''
                        }
                    }
                }
                stage('Frontend Image') {
                    steps {
                        echo 'âš›ï¸ í”„ë¡ íŠ¸ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...'
                        dir('frontend') {
                            sh '''
                                docker build -t ${PROJECT_NAME}-frontend:${BUILD_VERSION} .
                                docker tag ${PROJECT_NAME}-frontend:${BUILD_VERSION} ${PROJECT_NAME}-frontend:latest
                                echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
                            '''
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“¤ Push to Registry') {
            parallel {
                stage('Push Backend') {
                    steps {
                        echo 'ğŸ“¤ ë°±ì—”ë“œ ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ ì¤‘...'
                        sh '''
                            docker tag ${PROJECT_NAME}-backend:${BUILD_VERSION} ${DOCKER_REGISTRY}/${PROJECT_NAME}-backend:${BUILD_VERSION}
                            docker tag ${PROJECT_NAME}-backend:latest ${DOCKER_REGISTRY}/${PROJECT_NAME}-backend:latest
                            
                            docker push ${DOCKER_REGISTRY}/${PROJECT_NAME}-backend:${BUILD_VERSION}
                            docker push ${DOCKER_REGISTRY}/${PROJECT_NAME}-backend:latest
                            
                            echo "âœ… ë°±ì—”ë“œ ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
                        '''
                    }
                }
                stage('Push Frontend') {
                    steps {
                        echo 'ğŸ“¤ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ ì¤‘...'
                        sh '''
                            docker tag ${PROJECT_NAME}-frontend:${BUILD_VERSION} ${DOCKER_REGISTRY}/${PROJECT_NAME}-frontend:${BUILD_VERSION}
                            docker tag ${PROJECT_NAME}-frontend:latest ${DOCKER_REGISTRY}/${PROJECT_NAME}-frontend:latest
                            
                            docker push ${DOCKER_REGISTRY}/${PROJECT_NAME}-frontend:${BUILD_VERSION}
                            docker push ${DOCKER_REGISTRY}/${PROJECT_NAME}-frontend:latest
                            
                            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
                        '''
                    }
                }
            }
        }
        
        stage('ğŸš€ Deploy to Kubernetes') {
            steps {
                echo 'â˜¸ï¸ Kubernetes ë°°í¬ ì¤‘...'
                sh '''
                    echo "ğŸ“ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì¤‘..."
                    
                    # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
                    kubectl create namespace ecp-ai-dev --dry-run=client -o yaml | kubectl apply -f -
                    
                    # ë°±ì—”ë“œ ë°°í¬
                    cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ecp-ai-backend
  namespace: ecp-ai-dev
  labels:
    app: ecp-ai-backend
    version: ${BUILD_VERSION}
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ecp-ai-backend
  template:
    metadata:
      labels:
        app: ecp-ai-backend
        version: ${BUILD_VERSION}
    spec:
      containers:
      - name: backend
        image: ${DOCKER_REGISTRY}/${PROJECT_NAME}-backend:${BUILD_VERSION}
        ports:
        - containerPort: 8000
        env:
        - name: ENVIRONMENT
          value: "development"
        - name: BUILD_VERSION
          value: "${BUILD_VERSION}"
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: ecp-ai-backend-service
  namespace: ecp-ai-dev
spec:
  selector:
    app: ecp-ai-backend
  ports:
  - port: 8000
    targetPort: 8000
  type: ClusterIP
EOF

                    # í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
                    cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ecp-ai-frontend
  namespace: ecp-ai-dev
  labels:
    app: ecp-ai-frontend
    version: ${BUILD_VERSION}
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ecp-ai-frontend
  template:
    metadata:
      labels:
        app: ecp-ai-frontend
        version: ${BUILD_VERSION}
    spec:
      containers:
      - name: frontend
        image: ${DOCKER_REGISTRY}/${PROJECT_NAME}-frontend:${BUILD_VERSION}
        ports:
        - containerPort: 3000
        env:
        - name: REACT_APP_API_URL
          value: "http://ecp-ai-backend-service:8000"
        - name: BUILD_VERSION
          value: "${BUILD_VERSION}"
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
---
apiVersion: v1
kind: Service
metadata:
  name: ecp-ai-frontend-service
  namespace: ecp-ai-dev
spec:
  selector:
    app: ecp-ai-frontend
  ports:
  - port: 3000
    targetPort: 3000
    nodePort: 30300
  type: NodePort
EOF

                    echo "âœ… Kubernetes ë°°í¬ ì™„ë£Œ"
                    
                    # ë°°í¬ ìƒíƒœ í™•ì¸
                    kubectl get pods -n ecp-ai-dev
                    kubectl get services -n ecp-ai-dev
                '''
            }
        }
        
        stage('ğŸ” Health Check') {
            steps {
                echo 'ğŸ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì¤‘...'
                sh '''
                    echo "â³ íŒŒë“œ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
                    kubectl wait --for=condition=ready pod -l app=ecp-ai-backend -n ecp-ai-dev --timeout=300s
                    kubectl wait --for=condition=ready pod -l app=ecp-ai-frontend -n ecp-ai-dev --timeout=300s
                    
                    echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
                    kubectl get pods -n ecp-ai-dev -o wide
                    
                    echo "âœ… í—¬ìŠ¤ì²´í¬ ì™„ë£Œ"
                '''
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ§¹ ë¹Œë“œ ì •ë¦¬ ì¤‘...'
            sh '''
                # ë¡œì»¬ Docker ì´ë¯¸ì§€ ì •ë¦¬
                docker image prune -f
                
                echo "ğŸ“Š ë¹Œë“œ ê²°ê³¼ ìš”ì•½:"
                echo "  ğŸ“¦ í”„ë¡œì íŠ¸: ${PROJECT_NAME}"
                echo "  ğŸ·ï¸ ë²„ì „: ${BUILD_VERSION}"
                echo "  ğŸ”— Git ì»¤ë°‹: ${GIT_COMMIT}"
                echo "  ğŸ“… ë¹Œë“œ ì‹œê°„: $(date)"
            '''
        }
        success {
            echo 'ğŸ‰ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!'
            sh '''
                echo "âœ… ECP-AI K8s Orchestrator ë°°í¬ ì„±ê³µ!"
                echo "ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ ì ‘ì†: http://localhost:30300"
                echo "ğŸ”§ ë°±ì—”ë“œ API: http://localhost:30300/api"
            '''
        }
        failure {
            echo 'âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!'
            sh '''
                echo "ğŸ’¥ ë¹Œë“œ ì‹¤íŒ¨ - ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
                kubectl get events -n ecp-ai-dev --sort-by='.lastTimestamp' | tail -10
            '''
        }
    }
}</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>
